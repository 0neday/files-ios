#include <errno.h>              // errno
#include <stdint.h>             // uint32_t
#include <string.h>             // strncmp, strerror
#include <sys/sysctl.h>         // CTL_*, KERN_OSVERSION, HW_MODEL, sysctl


#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/utsname.h>
#include "sys/sysctl.h"


#include "device.h"


#define VERSION(name) \
do \
{ \
    if(strncmp(#name, b, s) == 0) return V_##name; \
} while(0)


uint32_t get_os_version_internal(void)
{
		// Static so we can use it in  printf
		static char b[32];
		size_t s = sizeof(b);
		// sysctl("kern.osversion")
		int cmd[2] = { CTL_KERN, KERN_OSVERSION };
		if(sysctl(cmd, sizeof(cmd) / sizeof(*cmd), b, &s, NULL, 0) != 0)
		{
				 printf("sysctl(\"kern.osversion\") failed: %s\n", strerror(errno));
		}
		printf("OS build: %s\n", b);

		VERSION(13A340);
		VERSION(13A342);
		VERSION(13A343);
		VERSION(13A344);
		VERSION(13A404);
		VERSION(13A405);
		VERSION(13A452);
		VERSION(13B138);
		VERSION(13B143);
		VERSION(13B144);
		VERSION(13C75);
		VERSION(13D15);
		VERSION(13D20);
		VERSION(13E233);
		VERSION(13E234);
		VERSION(13E236);
		VERSION(13E237);
		VERSION(13E238);
		VERSION(13F69);
		VERSION(13F72);
		VERSION(13G34);
		VERSION(13G35);
		VERSION(13G36); // 9.3.5
		printf("Unrecognized OS version: %s\n", b);
		return 0;
}

uint32_t get_os_version(void)
{
	static uint32_t ret = 0;
	ret = get_os_version_internal();
	return ret;
}
